// Generated by CoffeeScript 2.7.0
var META_KEY, VERSION, VERSION_MAJOR, VERSION_MINOR, VERSION_PATCH, addDataElement, inputElement, locateInputElement, log, metaData, metaDataElement, prepareDataElement, queryDataElement, setKey, updateDataElement, updateTimestamp;

META_KEY = "cgptihkv1";

VERSION = [VERSION_MAJOR = 1, VERSION_MINOR = 2, VERSION_PATCH = 1].join('.');

log = function(s, ...args) {
  return console.log("[cGPTts Content]: " + s, ...args);
};

metaData = {};

inputElement = null;

metaDataElement = null;

locateInputElement = function() {
  var currentInputElement;
  if (!(currentInputElement = document.querySelector("#prompt-textarea"))) {
    log("error locating inputElement");
  }
  if (currentInputElement !== inputElement) {
    log("inputElement changed");
  }
  return inputElement = currentInputElement;
};

prepareDataElement = function() {
  var firstChild, text;
  if (!locateInputElement()) {
    return;
  }
  if (!(firstChild = inputElement.children[0])) {
    addDataElement();
    return;
  }
  text = firstChild.innerHTML[0];
  try {
    return JSON.parse(text);
  } catch (error) {
    return addDataElement();
  }
};

addDataElement = function() {
  metaDataElement = document.createElement('p');
  metaDataElement.innerHTML = '{}';
  return inputElement.prepend(metaDataElement);
};

updateDataElement = function() {
  if (!prepareDataElement()) {
    return;
  }
  return metaDataElement.innerHTML = JSON.stringify(metaData);
};

queryDataElement = function() {
  var value;
  if (!prepareDataElement()) {
    return;
  }
  value = null;
  try {
    value = JSON.stringify(metaDataElement.innerHTML);
  } catch (error) {}
  return value;
};

setKey = function(key, value) {
  metaData[key] = value;
  return updateDataElement();
};

updateTimestamp = function(which) {
  return setKey('timestamp' + which, Date.now());
};

/*

getOrSetInputElement = ->
  if inputElement isnt currentInputElement
    log "inputElement updating"
    inputElement = currentInputElement
    resetMetaData()

setMetaHTML = ->
  metaElement.innerHTML = JSON.stringify metaData

resetMetaData = ->
  metaData = Object.assign key: META_KEY, start: Date.now()
  metaElement = document.createElement 'p'
  inputElement.prepend metaElement
  setMetaHTML()

updateMetaData = (changes) ->
  log "updateMetaData: " + JSON.stringify changes
  getOrSetInputElement()

  Object.assign metaData, changes
  setMetaHTML()

addOrUpdateTimestamp = (stampName) -> updateMetaData [stampName]: Date.now()

insertTimestamp = (location) ->
  log "insertTimestamp (#{location})"

  if not inputField = document.querySelector "#prompt-textarea"
    log "error locating inputField"
    return

  log "inputField HTML contents: " + inputField.getHTML()

  timestamp = new Date().toISOString()

  (newParagraph = document.createElement "p")
    .classList.add "timestamp", location

  [newParagraph.textContent, prefix] =
    if location is "start"
      [ "[#{timestamp} response received]", "pre" ]
    else
      [ "[#{timestamp} query sent]",        "ap" ]

  addIfAbsent prefix, "timestamp", newParagraph, inputField

waitForInputField = (callback) ->
  attempt = 0
  check = ->
    inputField = document.querySelector "#prompt-textarea"
    if inputField?
      log "Found input field!"

      callback(inputField)
    else if attempt < 10
      attempt++
      log "Retrying to find input field... Attempt #{attempt}"

      setTimeout check, 500
    else
      log "Gave up finding #prompt-textarea"

  check()

waitForInputField (inputField) ->
  if not inputField.dataset.tsListenersAdded
    inputField.dataset.tsListenersAdded = "true"

    inputField.addEventListener "input", (event) ->
      log "Input detected! Current content: #{inputField.value}"

    inputField.addEventListener "keydown", (event) ->
      if event.key is "Enter"
        if event.shiftKey
          log "Ignoring shift-enter"
        else
          log "Enter key detected"
          updateTimestamp "querySent"

updateEndTimestamp = ->
  log "updateEndTimestamp"

  if pid = updateEndTimestamp.pid
    clearTimeout pid

  addOrUpdateTimestamp "querySent"
  updateEndTimestamp.pid = setTimeout 100, updateEndTimestamp

browser
  .runtime
  .onMessage
  .addListener (message, sender, sendResponse) ->
    log "Message received from background"

    if message.action is "insertTimestamp"
      getOrSetInputElement()

      if not metaData.responseReceived
        addOrUpdateTimestamp "responseReceived"

    updateEndTimestamp()

*/
log(`doc loaded (v${VERSION})`);

//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29udGVudC5qcyIsInNvdXJjZVJvb3QiOiIuLi8iLCJzb3VyY2VzIjpbInNyYy9jb250ZW50LmNvZmZlZSJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsSUFBQSxRQUFBLEVBQUEsT0FBQSxFQUFBLGFBQUEsRUFBQSxhQUFBLEVBQUEsYUFBQSxFQUFBLGNBQUEsRUFBQSxZQUFBLEVBQUEsa0JBQUEsRUFBQSxHQUFBLEVBQUEsUUFBQSxFQUFBLGVBQUEsRUFBQSxrQkFBQSxFQUFBLGdCQUFBLEVBQUEsTUFBQSxFQUFBLGlCQUFBLEVBQUE7O0FBQUEsUUFBQSxHQUFXOztBQUNYLE9BQUEsR0FBVSxDQUNSLGFBQUEsR0FBZ0IsQ0FEUixFQUVSLGFBQUEsR0FBZ0IsQ0FGUixFQUdSLGFBQUEsR0FBZ0IsQ0FIUixDQUlULENBQUMsSUFKUSxDQUlILEdBSkc7O0FBTVYsR0FBQSxHQUFNLFFBQUEsQ0FBQyxDQUFELEVBQUEsR0FBSSxJQUFKLENBQUE7U0FBZ0IsT0FBTyxDQUFDLEdBQVIsQ0FBWSxvQkFBQSxHQUF1QixDQUFuQyxFQUFzQyxHQUFBLElBQXRDO0FBQWhCOztBQUVOLFFBQUEsR0FBa0IsQ0FBQTs7QUFDbEIsWUFBQSxHQUFrQjs7QUFDbEIsZUFBQSxHQUFrQjs7QUFFbEIsa0JBQUEsR0FBcUIsUUFBQSxDQUFBLENBQUE7QUFDckIsTUFBQTtFQUFFLElBQUcsQ0FBSSxDQUFBLG1CQUFBLEdBQXNCLFFBQVEsQ0FBQyxhQUFULENBQXVCLGtCQUF2QixDQUF0QixDQUFQO0lBQ0UsR0FBQSxDQUFJLDZCQUFKLEVBREY7O0VBR0EsSUFBRyxtQkFBQSxLQUF5QixZQUE1QjtJQUNFLEdBQUEsQ0FBSSxzQkFBSixFQURGOztTQUdBLFlBQUEsR0FBZTtBQVBJOztBQVVyQixrQkFBQSxHQUFxQixRQUFBLENBQUEsQ0FBQTtBQUNyQixNQUFBLFVBQUEsRUFBQTtFQUFFLElBQVUsQ0FBSSxrQkFBQSxDQUFBLENBQWQ7QUFBQSxXQUFBOztFQUVBLElBQUcsQ0FBSSxDQUFBLFVBQUEsR0FBYSxZQUFZLENBQUMsUUFBUSxDQUFDLENBQUQsQ0FBbEMsQ0FBUDtJQUNFLGNBQUEsQ0FBQTtBQUNBLFdBRkY7O0VBSUEsSUFBQSxHQUFPLFVBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBRDtBQUUzQjtXQUNFLElBQUksQ0FBQyxLQUFMLENBQVcsSUFBWCxFQURGO0dBRUEsYUFBQTtXQUNFLGNBQUEsQ0FBQSxFQURGOztBQVhtQjs7QUFjckIsY0FBQSxHQUFpQixRQUFBLENBQUEsQ0FBQTtFQUNmLGVBQUEsR0FBa0IsUUFBUSxDQUFDLGFBQVQsQ0FBdUIsR0FBdkI7RUFDbEIsZUFBZSxDQUFDLFNBQWhCLEdBQTRCO1NBQzVCLFlBQVksQ0FBQyxPQUFiLENBQXFCLGVBQXJCO0FBSGU7O0FBS2pCLGlCQUFBLEdBQW9CLFFBQUEsQ0FBQSxDQUFBO0VBQ2xCLElBQVUsQ0FBSSxrQkFBQSxDQUFBLENBQWQ7QUFBQSxXQUFBOztTQUVBLGVBQWUsQ0FBQyxTQUFoQixHQUE0QixJQUFJLENBQUMsU0FBTCxDQUFlLFFBQWY7QUFIVjs7QUFLcEIsZ0JBQUEsR0FBbUIsUUFBQSxDQUFBLENBQUE7QUFDbkIsTUFBQTtFQUFFLElBQVUsQ0FBSSxrQkFBQSxDQUFBLENBQWQ7QUFBQSxXQUFBOztFQUVBLEtBQUEsR0FBUTtBQUVSO0lBQ0UsS0FBQSxHQUFRLElBQUksQ0FBQyxTQUFMLENBQWUsZUFBZSxDQUFDLFNBQS9CLEVBRFY7R0FBQTtBQUdBLFNBQU87QUFSVTs7QUFVbkIsTUFBQSxHQUFTLFFBQUEsQ0FBQyxHQUFELEVBQU0sS0FBTixDQUFBO0VBQ1AsUUFBUSxDQUFDLEdBQUQsQ0FBUixHQUFnQjtTQUNoQixpQkFBQSxDQUFBO0FBRk87O0FBSVQsZUFBQSxHQUFrQixRQUFBLENBQUMsS0FBRCxDQUFBO1NBQVcsTUFBQSxDQUFPLFdBQUEsR0FBYyxLQUFyQixFQUE0QixJQUFJLENBQUMsR0FBTCxDQUFBLENBQTVCO0FBQVgsRUE3RGxCOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQThLQSxHQUFBLENBQUksQ0FBQSxhQUFBLENBQUEsQ0FBZ0IsT0FBaEIsQ0FBQSxDQUFBLENBQUoiLCJzb3VyY2VzQ29udGVudCI6WyJNRVRBX0tFWSA9IFwiY2dwdGloa3YxXCJcblZFUlNJT04gPSBbXG4gIFZFUlNJT05fTUFKT1IgPSAxXG4gIFZFUlNJT05fTUlOT1IgPSAyXG4gIFZFUlNJT05fUEFUQ0ggPSAxXG5dLmpvaW4gJy4nXG5cbmxvZyA9IChzLCBhcmdzLi4uKSAtPiBjb25zb2xlLmxvZyBcIltjR1BUdHMgQ29udGVudF06IFwiICsgcywgYXJncy4uLlxuXG5tZXRhRGF0YSAgICAgICAgPSB7fVxuaW5wdXRFbGVtZW50ICAgID0gbnVsbFxubWV0YURhdGFFbGVtZW50ID0gbnVsbFxuXG5sb2NhdGVJbnB1dEVsZW1lbnQgPSAtPlxuICBpZiBub3QgY3VycmVudElucHV0RWxlbWVudCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IgXCIjcHJvbXB0LXRleHRhcmVhXCJcbiAgICBsb2cgXCJlcnJvciBsb2NhdGluZyBpbnB1dEVsZW1lbnRcIlxuXG4gIGlmIGN1cnJlbnRJbnB1dEVsZW1lbnQgaXNudCBpbnB1dEVsZW1lbnRcbiAgICBsb2cgXCJpbnB1dEVsZW1lbnQgY2hhbmdlZFwiXG5cbiAgaW5wdXRFbGVtZW50ID0gY3VycmVudElucHV0RWxlbWVudFxuXG5cbnByZXBhcmVEYXRhRWxlbWVudCA9IC0+XG4gIHJldHVybiBpZiBub3QgbG9jYXRlSW5wdXRFbGVtZW50KClcblxuICBpZiBub3QgZmlyc3RDaGlsZCA9IGlucHV0RWxlbWVudC5jaGlsZHJlblswXVxuICAgIGFkZERhdGFFbGVtZW50KClcbiAgICByZXR1cm5cblxuICB0ZXh0ID0gZmlyc3RDaGlsZC5pbm5lckhUTUxbMF1cblxuICB0cnlcbiAgICBKU09OLnBhcnNlIHRleHRcbiAgY2F0Y2hcbiAgICBhZGREYXRhRWxlbWVudCgpXG5cbmFkZERhdGFFbGVtZW50ID0gLT5cbiAgbWV0YURhdGFFbGVtZW50ID0gZG9jdW1lbnQuY3JlYXRlRWxlbWVudCAncCdcbiAgbWV0YURhdGFFbGVtZW50LmlubmVySFRNTCA9ICd7fSdcbiAgaW5wdXRFbGVtZW50LnByZXBlbmQgbWV0YURhdGFFbGVtZW50XG5cbnVwZGF0ZURhdGFFbGVtZW50ID0gLT5cbiAgcmV0dXJuIGlmIG5vdCBwcmVwYXJlRGF0YUVsZW1lbnQoKVxuXG4gIG1ldGFEYXRhRWxlbWVudC5pbm5lckhUTUwgPSBKU09OLnN0cmluZ2lmeSBtZXRhRGF0YVxuXG5xdWVyeURhdGFFbGVtZW50ID0gLT5cbiAgcmV0dXJuIGlmIG5vdCBwcmVwYXJlRGF0YUVsZW1lbnQoKVxuXG4gIHZhbHVlID0gbnVsbFxuXG4gIHRyeVxuICAgIHZhbHVlID0gSlNPTi5zdHJpbmdpZnkgbWV0YURhdGFFbGVtZW50LmlubmVySFRNTFxuXG4gIHJldHVybiB2YWx1ZVxuXG5zZXRLZXkgPSAoa2V5LCB2YWx1ZSkgLT5cbiAgbWV0YURhdGFba2V5XSA9IHZhbHVlXG4gIHVwZGF0ZURhdGFFbGVtZW50KClcblxudXBkYXRlVGltZXN0YW1wID0gKHdoaWNoKSAtPiBzZXRLZXkgJ3RpbWVzdGFtcCcgKyB3aGljaCwgRGF0ZS5ub3coKVxuXG4jIyNcblxuZ2V0T3JTZXRJbnB1dEVsZW1lbnQgPSAtPlxuICBpZiBpbnB1dEVsZW1lbnQgaXNudCBjdXJyZW50SW5wdXRFbGVtZW50XG4gICAgbG9nIFwiaW5wdXRFbGVtZW50IHVwZGF0aW5nXCJcbiAgICBpbnB1dEVsZW1lbnQgPSBjdXJyZW50SW5wdXRFbGVtZW50XG4gICAgcmVzZXRNZXRhRGF0YSgpXG5cbnNldE1ldGFIVE1MID0gLT5cbiAgbWV0YUVsZW1lbnQuaW5uZXJIVE1MID0gSlNPTi5zdHJpbmdpZnkgbWV0YURhdGFcblxucmVzZXRNZXRhRGF0YSA9IC0+XG4gIG1ldGFEYXRhID0gT2JqZWN0LmFzc2lnbiBrZXk6IE1FVEFfS0VZLCBzdGFydDogRGF0ZS5ub3coKVxuICBtZXRhRWxlbWVudCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgJ3AnXG4gIGlucHV0RWxlbWVudC5wcmVwZW5kIG1ldGFFbGVtZW50XG4gIHNldE1ldGFIVE1MKClcblxuXG51cGRhdGVNZXRhRGF0YSA9IChjaGFuZ2VzKSAtPlxuICBsb2cgXCJ1cGRhdGVNZXRhRGF0YTogXCIgKyBKU09OLnN0cmluZ2lmeSBjaGFuZ2VzXG4gIGdldE9yU2V0SW5wdXRFbGVtZW50KClcblxuICBPYmplY3QuYXNzaWduIG1ldGFEYXRhLCBjaGFuZ2VzXG4gIHNldE1ldGFIVE1MKClcblxuXG5hZGRPclVwZGF0ZVRpbWVzdGFtcCA9IChzdGFtcE5hbWUpIC0+IHVwZGF0ZU1ldGFEYXRhIFtzdGFtcE5hbWVdOiBEYXRlLm5vdygpXG5cblxuaW5zZXJ0VGltZXN0YW1wID0gKGxvY2F0aW9uKSAtPlxuICBsb2cgXCJpbnNlcnRUaW1lc3RhbXAgKCN7bG9jYXRpb259KVwiXG5cbiAgaWYgbm90IGlucHV0RmllbGQgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yIFwiI3Byb21wdC10ZXh0YXJlYVwiXG4gICAgbG9nIFwiZXJyb3IgbG9jYXRpbmcgaW5wdXRGaWVsZFwiXG4gICAgcmV0dXJuXG5cbiAgbG9nIFwiaW5wdXRGaWVsZCBIVE1MIGNvbnRlbnRzOiBcIiArIGlucHV0RmllbGQuZ2V0SFRNTCgpXG5cbiAgdGltZXN0YW1wID0gbmV3IERhdGUoKS50b0lTT1N0cmluZygpXG5cbiAgKG5ld1BhcmFncmFwaCA9IGRvY3VtZW50LmNyZWF0ZUVsZW1lbnQgXCJwXCIpXG4gICAgLmNsYXNzTGlzdC5hZGQgXCJ0aW1lc3RhbXBcIiwgbG9jYXRpb25cblxuICBbbmV3UGFyYWdyYXBoLnRleHRDb250ZW50LCBwcmVmaXhdID1cbiAgICBpZiBsb2NhdGlvbiBpcyBcInN0YXJ0XCJcbiAgICAgIFsgXCJbI3t0aW1lc3RhbXB9IHJlc3BvbnNlIHJlY2VpdmVkXVwiLCBcInByZVwiIF1cbiAgICBlbHNlXG4gICAgICBbIFwiWyN7dGltZXN0YW1wfSBxdWVyeSBzZW50XVwiLCAgICAgICAgXCJhcFwiIF1cblxuICBhZGRJZkFic2VudCBwcmVmaXgsIFwidGltZXN0YW1wXCIsIG5ld1BhcmFncmFwaCwgaW5wdXRGaWVsZFxuXG5cbndhaXRGb3JJbnB1dEZpZWxkID0gKGNhbGxiYWNrKSAtPlxuICBhdHRlbXB0ID0gMFxuICBjaGVjayA9IC0+XG4gICAgaW5wdXRGaWVsZCA9IGRvY3VtZW50LnF1ZXJ5U2VsZWN0b3IgXCIjcHJvbXB0LXRleHRhcmVhXCJcbiAgICBpZiBpbnB1dEZpZWxkP1xuICAgICAgbG9nIFwiRm91bmQgaW5wdXQgZmllbGQhXCJcblxuICAgICAgY2FsbGJhY2soaW5wdXRGaWVsZClcbiAgICBlbHNlIGlmIGF0dGVtcHQgPCAxMFxuICAgICAgYXR0ZW1wdCsrXG4gICAgICBsb2cgXCJSZXRyeWluZyB0byBmaW5kIGlucHV0IGZpZWxkLi4uIEF0dGVtcHQgI3thdHRlbXB0fVwiXG5cbiAgICAgIHNldFRpbWVvdXQgY2hlY2ssIDUwMFxuICAgIGVsc2VcbiAgICAgIGxvZyBcIkdhdmUgdXAgZmluZGluZyAjcHJvbXB0LXRleHRhcmVhXCJcblxuICBjaGVjaygpXG5cbndhaXRGb3JJbnB1dEZpZWxkIChpbnB1dEZpZWxkKSAtPlxuICBpZiBub3QgaW5wdXRGaWVsZC5kYXRhc2V0LnRzTGlzdGVuZXJzQWRkZWRcbiAgICBpbnB1dEZpZWxkLmRhdGFzZXQudHNMaXN0ZW5lcnNBZGRlZCA9IFwidHJ1ZVwiXG5cbiAgICBpbnB1dEZpZWxkLmFkZEV2ZW50TGlzdGVuZXIgXCJpbnB1dFwiLCAoZXZlbnQpIC0+XG4gICAgICBsb2cgXCJJbnB1dCBkZXRlY3RlZCEgQ3VycmVudCBjb250ZW50OiAje2lucHV0RmllbGQudmFsdWV9XCJcblxuICAgIGlucHV0RmllbGQuYWRkRXZlbnRMaXN0ZW5lciBcImtleWRvd25cIiwgKGV2ZW50KSAtPlxuICAgICAgaWYgZXZlbnQua2V5IGlzIFwiRW50ZXJcIlxuICAgICAgICBpZiBldmVudC5zaGlmdEtleVxuICAgICAgICAgIGxvZyBcIklnbm9yaW5nIHNoaWZ0LWVudGVyXCJcbiAgICAgICAgZWxzZVxuICAgICAgICAgIGxvZyBcIkVudGVyIGtleSBkZXRlY3RlZFwiXG4gICAgICAgICAgdXBkYXRlVGltZXN0YW1wIFwicXVlcnlTZW50XCJcblxuXG51cGRhdGVFbmRUaW1lc3RhbXAgPSAtPlxuICBsb2cgXCJ1cGRhdGVFbmRUaW1lc3RhbXBcIlxuXG4gIGlmIHBpZCA9IHVwZGF0ZUVuZFRpbWVzdGFtcC5waWRcbiAgICBjbGVhclRpbWVvdXQgcGlkXG5cbiAgYWRkT3JVcGRhdGVUaW1lc3RhbXAgXCJxdWVyeVNlbnRcIlxuICB1cGRhdGVFbmRUaW1lc3RhbXAucGlkID0gc2V0VGltZW91dCAxMDAsIHVwZGF0ZUVuZFRpbWVzdGFtcFxuXG5icm93c2VyXG4gIC5ydW50aW1lXG4gIC5vbk1lc3NhZ2VcbiAgLmFkZExpc3RlbmVyIChtZXNzYWdlLCBzZW5kZXIsIHNlbmRSZXNwb25zZSkgLT5cbiAgICBsb2cgXCJNZXNzYWdlIHJlY2VpdmVkIGZyb20gYmFja2dyb3VuZFwiXG5cbiAgICBpZiBtZXNzYWdlLmFjdGlvbiBpcyBcImluc2VydFRpbWVzdGFtcFwiXG4gICAgICBnZXRPclNldElucHV0RWxlbWVudCgpXG5cbiAgICAgIGlmIG5vdCBtZXRhRGF0YS5yZXNwb25zZVJlY2VpdmVkXG4gICAgICAgIGFkZE9yVXBkYXRlVGltZXN0YW1wIFwicmVzcG9uc2VSZWNlaXZlZFwiXG5cbiAgICB1cGRhdGVFbmRUaW1lc3RhbXAoKVxuXG4jIyNcblxubG9nIFwiZG9jIGxvYWRlZCAodiN7VkVSU0lPTn0pXCJcblxuIl19
//# sourceURL=/Users/robert/git/github/rdeforest/ChatGPT-timestamp/src/content.coffee